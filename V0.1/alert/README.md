# 加密货币价格监控工具

这是一个基于Python的加密货币价格监控工具，可以自动监控多个加密货币的价格和技术指标，并在满足条件时发送交易信号提醒。该工具通过币安API获取实时数据，使用多种技术指标进行综合分析，为交易决策提供参考。

## 核心功能

### 1. 多币种实时监控
- 支持同时监控多个加密货币交易对（BTC、ETH、SOL、XRP、AVAX、BNB等）
- 从币安API获取实时K线数据（5分钟、15分钟、1小时周期）
- 自动计算多种技术指标并进行综合评分

### 2. 智能信号系统
- **评分机制**：采用12分制评分系统，满分条件下触发信号
- **双向信号**：支持做多和做空两种信号类型
- **阈值控制**：可配置信号触发的最低分数阈值（默认6分）
- **信号去重**：避免重复发送相同的信号提醒

### 3. 高级冷静期机制
- **观察期设计**：信号消失后进入可配置的观察期（默认60分钟）
- **状态保持**：观察期内信号重新出现时继续跟踪，避免状态频繁切换
- **智能重置**：只有观察期结束且信号未重现时才重置状态
- **防止噪音**：有效过滤短期市场波动造成的虚假信号

### 4. 多渠道通知系统
- **飞书机器人**：支持通过飞书webhook发送格式化消息
- **声音提醒**：本地运行时支持声音提醒（reminder.py）
- **详细信息**：包含价格、时间、币安链接等完整信息

### 5. 健壮的错误处理
- **自动重试**：API请求失败时最多重试3次，带随机延迟
- **错误统计**：记录每个币种的连续失败次数
- **故障通知**：连续3次失败时自动发送警告通知
- **异常恢复**：程序异常时发送紧急通知

### 6. 状态持久化
- **JSON存储**：使用alert_status.json文件保存运行状态
- **状态恢复**：程序重启后自动恢复之前的监控状态
- **时间处理**：正确处理datetime对象的序列化和反序列化

## 技术指标体系

### 核心指标
- **EMA9**：9周期指数移动平均线（5分钟、15分钟、1小时）
- **EMA21**：21周期指数移动平均线（5分钟、15分钟、1小时）
- **EMA靠近度**：EMA9与EMA21的靠近程度分析
- **RSI**：14周期相对强弱指数
- **ATR**：14周期平均真实波幅
- **成交量分析**：当前成交量与历史平均值对比

### 评分规则
每个指标根据市场条件给出相应分数，总分12分：
- **趋势判断**（4分）：价格与EMA21的关系
- **动量指标**（1分）：RSI在合理区间
- **价格贴近度**（1分）：价格接近EMA21支撑/阻力
- **波动性**（2分）：ATR放大表明市场活跃
- **成交量确认**（2分）：成交量放大确认趋势
- **EMA靠近度**（2分）：EMA9与EMA21靠近表明趋势转换机会

## 安装步骤

1. 确保已安装Python 3.x
2. 安装依赖包：
```bash
pip install requests
```

## 配置说明

所有配置都在 `config.json` 文件中，支持热更新（修改后下次执行时自动生效）：

### 基础配置
- **tokens**：监控的代币列表，每个包含symbol（交易对）和name（显示名称）
- **feishu_webhook**：飞书机器人webhook地址，用于发送提醒消息
- **cooldown_minutes**：信号冷静期时间（分钟），防止频繁提醒
- **signal_threshold**：触发信号所需的最低分数（1-10分）

### 技术指标参数
- **rsi_range**：RSI指标的有效区间（min-max），在此范围内得1分
- **price_ema_gap_ratio**：价格与EMA21的最大偏离比例，小于此值得1分
- **atr_ratio**：ATR放大倍数阈值，大于等于此值得2分
- **volume_ratio**：成交量放大倍数阈值，大于等于此值得2分
- **ema_convergence_threshold**：EMA9与EMA21靠近的阈值，小于此值得2分
- **ema_convergence_score**：EMA靠近时给予的分数

### 高级参数
- **price_change_threshold**：价格变化阈值，避免重复提醒
- **signal_score_change_threshold**：信号分数变化阈值
- **rsi_change_threshold**：RSI变化阈值

### 完整配置示例
```json
{
    "tokens": [
        {"symbol": "BTCUSDT", "name": "BTC"},
        {"symbol": "ETHUSDT", "name": "ETH"},
        {"symbol": "SOLUSDT", "name": "SOL"},
        {"symbol": "XRPUSDT", "name": "XRP"},
        {"symbol": "AVAXUSDT", "name": "AVAX"},
        {"symbol": "BNBUSDT", "name": "BNB"}
    ],
    "feishu_webhook": "https://open.feishu.cn/open-apis/bot/v2/hook/your_webhook_id",
    "cooldown_minutes": 60,
    "signal_threshold": 6,
    "rsi_range": {
        "min": 40,
        "max": 60
    },
    "price_ema_gap_ratio": 0.003,
    "atr_ratio": 1.1,
    "volume_ratio": 1.3,
    "price_change_threshold": 0.01,
    "signal_score_change_threshold": 2,
    "rsi_change_threshold": 5,
    "ema_convergence_threshold": 0.001,
    "ema_convergence_score": 2
}
```

## 使用方法

项目包含两个主要脚本文件：

### 1. alert_15m.py（推荐用于服务器部署）
- **功能**：核心监控脚本，适合定时任务运行
- **特点**：轻量级，只发送飞书通知，无声音提醒
- **用途**：服务器后台监控，通过crontab定时执行

**本地测试运行：**
```bash
python alert_15m.py
```

**服务器部署：**
1. 上传文件到服务器
2. 设置crontab定时任务（每5分钟执行一次）：
```bash
*/5 * * * * cd /home/ubuntu/tasks/alert && /home/ubuntu/tasks/alert/venv/bin/python /home/ubuntu/tasks/alert/alert_15m.py >> /home/ubuntu/tasks/alert/alert_15m.log 2>&1
```

### 2. reminder.py（适合本地运行）
- **功能**：完整版监控脚本，包含声音提醒功能
- **特点**：支持飞书通知 + 本地声音提醒
- **用途**：本地开发环境或个人电脑使用
- **依赖**：需要安装playsound库（Windows）或使用afplay（macOS）

**本地运行：**
```bash
# 安装声音播放依赖（Windows）
pip install playsound

# 运行脚本
python reminder.py
```

### Windows系统运行

**使用PowerShell：**
```powershell
# 切换到项目目录
cd d:\Code\AutoTrader\alert

# 运行监控脚本
python alert_15m.py

# 或运行带声音提醒的版本
python reminder.py
```

**设置Windows任务计划程序：**
1. 打开"任务计划程序"
2. 创建基本任务，设置每5分钟运行一次
3. 操作设置为运行程序：`python.exe`
4. 参数设置为：`d:\Code\AutoTrader\alert\alert_15m.py`
5. 起始位置设置为：`d:\Code\AutoTrader\alert`

## 维护说明

### 修改配置

1. 修改配置文件：
```bash
nano /home/ubuntu/tasks/alert/config.json
```

2. 修改后无需重启，下次执行时会自动加载新配置

### 修改代码

1. 修改代码前先备份：
```bash
cp /home/ubuntu/tasks/alert/alert_15m.py /home/ubuntu/tasks/alert/alert_15m.py.bak
```

2. 编辑代码：
```bash
nano /home/ubuntu/tasks/alert/alert_15m.py
```

3. 测试修改后的代码：
```bash
cd /home/ubuntu/tasks/alert && /home/ubuntu/tasks/alert/venv/bin/python /home/ubuntu/tasks/alert/alert_15m.py
```

### 重启脚本

1. 检查当前运行状态：
```bash
ps aux | grep alert_15m.py
```

2. 如果需要重启，先停止当前进程：
```bash
pkill -f alert_15m.py
```

3. 重新加载crontab配置：
```bash
crontab -e
```
（编辑后保存即可）

4. 检查crontab服务状态：
```bash
service cron status
```

5. 如果需要立即执行，可以手动运行：
```bash
cd /home/ubuntu/tasks/alert && /home/ubuntu/tasks/alert/venv/bin/python /home/ubuntu/tasks/alert/alert_15m.py
```

### 查看日志

1. 实时查看日志：
```bash
tail -f /home/ubuntu/tasks/alert/alert_15m.log
```

2. 查看系统日志中的cron记录：
```bash
grep CRON /var/log/syslog | tail -n 20
```

## 信号规则详解

### 评分系统（总分12分）

#### 做多信号评分条件
1. **价格 > EMA21（15分钟）**：+2分 - 短期趋势向上
2. **价格 > EMA21（1小时）**：+2分 - 中期趋势向上
3. **RSI在有效区间**（默认40-60）：+1分 - 动量适中，避免超买超卖
4. **价格贴近EMA21**（偏离<0.3%）：+1分 - 接近支撑位，入场时机好
5. **ATR放大**（≥1.1倍）：+2分 - 市场波动性增加
6. **成交量放大**（≥1.3倍）：+2分 - 成交量确认趋势
7. **EMA9与EMA21靠近**（偏离<0.1%）：+2分 - 均线靠近表明趋势转换机会

#### 做空信号评分条件
1. **价格 < EMA21（15分钟）**：+2分 - 短期趋势向下
2. **价格 < EMA21（1小时）**：+2分 - 中期趋势向下
3. **RSI在有效区间**（默认40-60）：+1分 - 动量适中，避免超买超卖
4. **价格贴近EMA21**（偏离<0.3%）：+1分 - 接近阻力位，入场时机好
5. **ATR放大**（≥1.1倍）：+2分 - 市场波动性增加
6. **成交量放大**（≥1.3倍）：+2分 - 成交量确认趋势
7. **EMA9与EMA21靠近**（偏离<0.1%）：+2分 - 均线靠近表明趋势转换机会

### 信号触发机制

#### 基本触发条件
- **分数阈值**：达到配置的最低分数（默认6分）
- **价格变化**：自上次提醒后价格变化≥1%（避免重复提醒）
- **质量过滤**：RSI必须在合理区间，价格必须贴近EMA21

#### 信号去重逻辑
- 记录上次提醒的价格和RSI值
- 只有价格显著变化时才发送新的提醒
- 避免在相同价位重复发送信号

### 高级冷静期机制

#### 观察期设计
- **时长**：可配置（默认60分钟）
- **触发**：当信号分数低于阈值时开始计时
- **目的**：防止短期波动导致的状态频繁切换

#### 状态管理流程
1. **信号触发**：分数≥阈值且满足发送条件时触发信号
2. **信号消失**：分数<阈值时进入观察期，不立即重置状态
3. **观察期内**：如果信号重新出现，继续跟踪，重置观察期计时
4. **观察期结束**：超过设定时间且信号未重现，重置状态为未触发
5. **状态重置**：清除历史记录，下次信号将被视为首次触发

#### 冷静期优势
- **减少噪音**：过滤短期市场波动造成的虚假信号
- **提高质量**：确保信号的持续性和可靠性
- **避免疲劳**：减少无效提醒，提升用户体验
- **智能恢复**：在真正的趋势变化时及时响应

## 日志说明

- 程序运行日志保存在 `/home/ubuntu/tasks/alert/alert_15m.log` 文件中
- 包含每个代币的得分情况和信号触发记录
- 错误信息也会记录在日志中

## 项目文件结构

```
d:\Code\AutoTrader\alert\
├── README.md              # 项目说明文档
├── alert_15m.py          # 核心监控脚本（推荐服务器使用）
├── reminder.py           # 完整监控脚本（支持声音提醒）
├── config.json           # 配置文件（支持热更新）
├── alert_status.json     # 状态持久化文件（自动生成）
├── alert_15m.log         # 运行日志文件（自动生成）
├── yinxiao.mp3          # 声音提醒文件
└── yinxiao.wav          # 声音提醒文件（备用格式）
```

## 技术特点

### 1. 数据来源
- **API接口**：币安公开API，无需认证
- **数据类型**：K线数据（OHLCV）
- **时间周期**：5分钟、15分钟、1小时
- **数据量**：每次获取50根K线，确保指标计算准确性

### 2. 算法实现
- **EMA计算**：使用标准指数移动平均算法（EMA9和EMA21）
- **EMA靠近度分析**：计算EMA9与EMA21的相对偏离比例
- **RSI计算**：14周期相对强弱指数
- **ATR计算**：14周期平均真实波幅
- **成交量分析**：当前与21周期平均值对比

### 3. 系统架构
- **模块化设计**：配置、状态、计算、通知分离
- **状态持久化**：JSON格式存储，支持程序重启恢复
- **错误隔离**：单个币种错误不影响其他币种监控
- **热配置更新**：修改配置文件后自动生效

## 注意事项

### 运行环境
1. **Python版本**：建议Python 3.7+
2. **网络要求**：稳定的互联网连接，能访问币安API
3. **系统时间**：确保系统时间准确，影响K线数据获取
4. **文件权限**：确保脚本有读写配置和状态文件的权限

### 配置管理
1. **JSON格式**：配置文件必须是有效的JSON格式
2. **编码要求**：使用UTF-8编码，避免中文乱码
3. **参数调优**：根据市场情况和个人需求调整参数
4. **备份配置**：修改前建议备份原配置文件

### 安全考虑
1. **API限制**：币安API有频率限制，避免过于频繁请求
2. **Webhook安全**：保护飞书webhook地址，避免泄露
3. **日志管理**：定期清理日志文件，避免占用过多磁盘空间

## 错误处理机制

### 网络错误处理
- **自动重试**：API请求失败时最多重试3次
- **随机延迟**：重试间隔加入随机延迟，避免请求冲突
- **超时设置**：10秒请求超时，防止长时间等待

### 异常监控
- **错误统计**：记录每个币种的连续失败次数
- **警告通知**：连续3次失败时发送飞书警告
- **程序异常**：严重错误时发送紧急通知
- **日志记录**：所有错误详情记录到日志文件

### 数据验证
- **K线数据检查**：确保获取足够的历史数据
- **指标计算验证**：处理除零等数学异常
- **配置文件验证**：启动时检查配置文件格式

## 维护建议

### 日常维护
1. **监控日志**：定期查看alert_15m.log文件
2. **检查通知**：确认飞书机器人正常工作
3. **状态检查**：观察alert_status.json中的状态变化
4. **性能监控**：关注脚本执行时间和资源占用

### 参数优化
1. **回测验证**：修改参数前进行历史数据回测
2. **渐进调整**：小幅度调整参数，观察效果
3. **市场适应**：根据不同市场环境调整策略
4. **记录变更**：记录参数修改历史和效果

### 系统升级
1. **代码备份**：修改前备份当前版本
2. **测试环境**：在测试环境验证修改
3. **灰度发布**：先在部分币种测试新版本
4. **回滚准备**：准备快速回滚方案

## 扩展建议

### 功能扩展
- **更多指标**：添加MACD、布林带等技术指标
- **多时间框架**：支持更多时间周期分析
- **风险管理**：添加止损、止盈建议
- **回测功能**：历史数据回测验证策略

### 通知扩展
- **多渠道通知**：支持微信、邮件、短信等
- **自定义模板**：可配置的消息模板
- **分级通知**：根据信号强度分级提醒
- **图表生成**：生成价格走势图表

### 数据扩展
- **多交易所**：支持其他交易所数据
- **更多币种**：扩展到更多加密货币
- **基本面数据**：结合新闻、资金流向等数据
- **链上数据**：整合区块链数据分析